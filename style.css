// Usamos let para que el array de alumnos pueda ser modificado
let DATOS_ALUMNOS = []; 

// Mapeo para rastrear el estado de cada alumno (0: Retiro en Espera, 1: Llamado/Avisado, 2: Retirado)
const estados = {}; 

// --- Funciones de Almacenamiento ---

function guardarAlumnos() {
    localStorage.setItem('alumnos', JSON.stringify(DATOS_ALUMNOS));
}

function cargarAlumnos() {
    const alumnosGuardados = localStorage.getItem('alumnos');
    if (alumnosGuardados) {
        DATOS_ALUMNOS = JSON.parse(alumnosGuardados);
    }
}

// --- Funciones de Formulario ---

function agregarAlumno(event) {
    event.preventDefault(); 

    const inputNombre = document.getElementById('input-nombre');
    const inputCurso = document.getElementById('input-curso');

    const nombre = inputNombre.value.trim();
    const curso = inputCurso.value.trim();

    if (nombre === "" || curso === "") {
        alert("Por favor, ingrese el nombre y el curso.");
        return;
    }

    const nuevoId = Date.now(); 

    const nuevoAlumno = { 
        id: nuevoId, 
        nombre: nombre, 
        curso: curso 
    };

    DATOS_ALUMNOS.push(nuevoAlumno);
    guardarAlumnos(); 
    renderizarLista(); 

    inputNombre.value = '';
    inputCurso.value = '';
}


// --- Funciones de Interacci√≥n y Renderizaci√≥n ---

function renderizarLista() {
    const lista = document.getElementById('lista-alumnos');
    lista.innerHTML = ''; 

    if (DATOS_ALUMNOS.length === 0) {
        lista.innerHTML = '<li class="no-data">‚ùå La lista est√° vac√≠a. Use el formulario para a√±adir alumnos.</li>';
        return; 
    }
    
    DATOS_ALUMNOS.forEach(alumno => {
        // Inicializa el estado si no existe (por defecto: 0 - Retiro en Espera / Blanco)
        if (!estados[alumno.id]) {
            estados[alumno.id] = 0;
        }

        const item = document.createElement('li');
        item.classList.add('alumno-item');
        item.setAttribute('data-id', alumno.id);

        aplicarClaseDeEstado(item, estados[alumno.id]);

        item.innerHTML = `
            <h3>${alumno.nombre}</h3>
            <p>Curso: ${alumno.curso} | Estado: <span class="estado-texto">Retiro en Espera</span></p>
        `;

        item.addEventListener('click', () => cambiarEstado(alumno.id, item));

        lista.appendChild(item);
    });
}

function cambiarEstado(id, itemElemento) {
    // El estado avanza c√≠clicamente: 0 -> 1 -> 2 -> 0 
    let nuevoEstado = (estados[id] + 1) % 3;
    estados[id] = nuevoEstado;
    aplicarClaseDeEstado(itemElemento, nuevoEstado);
}

function aplicarClaseDeEstado(item, estado) {
    // 1. Elimina todas las clases de estado previas
    item.classList.remove('estado-avisado', 'estado-retirado');

    const estadoTextoElemento = item.querySelector('.estado-texto');
    let nombreEstado = 'Retiro en Espera'; // Estado por defecto (Blanco/Gris)

    if (estado === 1) { // üü° Llamado (Avisado)
        item.classList.add('estado-avisado');
        nombreEstado = 'LLAMADO (Alumno en camino)';
    } else if (estado === 2) { // üü¢ Retirado (Entregado)
        item.classList.add('estado-retirado');
        nombreEstado = 'RETIRADO (Entregado)';
    }

    if (estadoTextoElemento) {
        estadoTextoElemento.textContent = nombreEstado;
    }
}

// --- Inicializaci√≥n ---

document.addEventListener('DOMContentLoaded', () => {
    cargarAlumnos(); 
    
    const form = document.getElementById('form-agregar-alumno');
    form.addEventListener('submit', agregarAlumno);
    
    renderizarLista();
});
